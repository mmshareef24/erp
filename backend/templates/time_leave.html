<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Leave Requests</title>
  <link rel="stylesheet" href="/static/styles.css" />
  <style>
    .form-inline > * { margin-right: 8px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Leave Requests</h1>
    {% if error_message %}
    <div style="padding:10px;background:#ffe6e6;color:#7a0000;border:1px solid #f5c2c2;margin-bottom:10px;">
      {{ error_message }}
    </div>
    {% endif %}
    <form id="leave_form" method="post" action="/time/leave" class="form-inline">
      <select name="emp_id" required>
        <option value="">Select Employee</option>
        {% for emp in employees %}
          <option value="{{ emp.emp_id }}">{{ emp.emp_id }} - {{ emp.name }}</option>
        {% endfor %}
      </select>
      <select name="leave_type" id="leave_type" required>
        {% for t in leave_types %}
          <option value="{{ t.code }}">{{ t.name }}</option>
        {% endfor %}
      </select>
      <input type="date" name="start_date" id="start_date" required />
      <input type="date" name="end_date" id="end_date" required />
      <input type="text" name="reason" placeholder="Reason (optional)" />
      <button type="submit" id="submit_btn" class="btn">Submit</button>
    </form>
    <p class="muted" id="leave_note"></p>
    <p id="validation_msg" class="muted"></p>

    <h2 class="mt-2">Requests</h2>
    <table class="table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Employee</th>
          <th>Type</th>
          <th>Start</th>
          <th>End</th>
          <th>Days</th>
          <th>Policy Max</th>
          <th>Exceeds?</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
      {% for it in items %}
        <tr>
          <td>{{ it.id }}</td>
          <td>{{ it.emp_id }}</td>
          <td>{{ it.type_name or it.type }}</td>
          <td>{{ it.start }}</td>
          <td>{{ it.end }}</td>
          <td>{{ it.days }}</td>
          <td>{{ it.policy_max_days or '-' }}</td>
          <td>{% if it.exceeds_policy %}Yes{% else %}No{% endif %}</td>
          <td>{{ it.status }}</td>
          <td>
            {% if it.status != 'approved' %}
              <form method="post" action="/time/leave/{{ it.id }}/approve" style="display:inline;">
                <button type="submit" class="btn">Approve</button>
              </form>
            {% else %}
              —
            {% endif %}
          </td>
        </tr>
      {% else %}
        <tr><td colspan="8">No leave requests yet.</td></tr>
      {% endfor %}
      </tbody>
    </table>
    <p class="mt-2"><a href="/app/time">← Back to Time</a></p>
  </div>
  <script>
    const types = {{ leave_types | tojson }};
    const select = document.getElementById('leave_type');
    const noteEl = document.getElementById('leave_note');
    const startEl = document.getElementById('start_date');
    const endEl = document.getElementById('end_date');
    const submitBtn = document.getElementById('submit_btn');
    const validationEl = document.getElementById('validation_msg');
    function updateNote() {
      const code = select.value;
      const t = types.find(x => x.code === code);
      if (t) {
        noteEl.textContent = `Policy: ${t.note} • Max days: ${t.max_days}`;
      } else {
        noteEl.textContent = '';
      }
    }
    function daysBetween() {
      if (!startEl.value || !endEl.value) return 0;
      const sd = new Date(startEl.value);
      const ed = new Date(endEl.value);
      if (isNaN(sd.getTime()) || isNaN(ed.getTime())) return 0;
      const diffMs = ed.getTime() - sd.getTime();
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24)) + 1;
      return Math.max(diffDays, 0);
    }
    function updateValidation() {
      const t = types.find(x => x.code === select.value);
      const max = t ? Number(t.max_days) : null;
      const days = daysBetween();
      let msg = '';
      let exceed = false;
      if (max && days > max) {
        msg = `Requested ${days} day(s) exceeds policy max of ${max}.`;
        exceed = true;
      } else if (days > 0) {
        msg = `Requested ${days} day(s).`;
      }
      validationEl.textContent = msg;
      submitBtn.disabled = exceed;
    }
    select.addEventListener('change', updateNote);
    select.addEventListener('change', updateValidation);
    startEl.addEventListener('change', updateValidation);
    endEl.addEventListener('change', updateValidation);
    updateNote();
    updateValidation();
  </script>
</body>
</html>